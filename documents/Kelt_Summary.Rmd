---
title: "Snake River Steelhead Kelt Summary"
author:
- name: Ryan N. Kinzer
  affiliation: Research Division, Department of Fisheries Resources Management
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    number_sections: no
    fig_caption: yes
    toc: yes
    floating_toc: yes
    df_print: paged
  bookdown::word_document2:
    reference_docx: "../../../Templates/Word_template1.docx"
    number_sections: false
    toc: false
    toc_levels: 3
  bookdown::pdf_document2:
    citation_package: biblatex #natbib
    keep_tex: yes
    fig_caption: yes
    latex_engine: xelatex #pdflatex #xelatex
    template: C:\ryank\Templates\NPT_report_template2.tex
shorttitle: Kelt Summary
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
branding: yes
bibliography:
- kelt_summary.bib
- kelt_summary_package.bib
link-citations: true
csl: "../../../Templates/american-fisheries-society.csl" # Insert path for the bib-style
---

```{r setup, include=FALSE}
library(knitr)
library(kableExtra)

opts_chunk$set(echo = FALSE, message = FALSE, error = FALSE,
                      warning = FALSE)

options(knitr.kable.NA = '-')
```

```{r load-pkgs}
library(tidyverse)
library(lubridate)
library(flextable)
library(officer)
source('../R/theme_rk.R')
```

```{r cite-pkgs}
#knitr::write_bib(c('PITcleanr', 'tidyverse', 'flextable', 'bookdown', 'officer'), "../Document/kelt_summary_package.bib")
knitr::write_bib(.packages(), "../documents/kelt_summary_package.bib")
```

```{r load-data}
load('../data/kelt_data.Rda')
```

```{r append-gsi-group}
tmp <- read_csv('../../GSI_files/trt_gsi_pairing.csv')

tag_summary <- tag_summary %>%
  left_join(tmp %>%
              select(TRT_POPID, GSI_spawn = GSI_Group))

rm(tmp)
```
# Background

Unlike the semelparous life-history of salmon *Oncorhynchus spp.*, anadromous steelhead trout *O. mykiss* in the Pacific Northwest are capable of iteroparity, and potentially contribute to multiple brood years before death [@quinnBehaviorEcologyPacific2018]. To complete multiple spawning events, post-spawned steelhead, often in poor physical condition, immediately emigrate downstream towards the ocean and the abundant food sources to recover physiologically [@penneyProximateCompositionEnergy2014]. These post-spawned and downstream emigrating steelhead are commonly referred to as kelt [@quinnBehaviorEcologyPacific2018]. If successful in reaching the ocean, kelt recover for one or two years before migrating upstream again to become a repeat spawner [@need_citation]. Repeat spawning (i.e., iteroparity) is known to buffer against negative environmental stochasticity, increase genetic diveristy and may provide large boosts to population productivity. As such, and given the current downward abundance trends of Pacific Northwest steelhead [@need_citation], understanding the limiting factors to steelhead kelt and repeat spawner survival is essential to preserving steelhead populations and meeting recovery goals.

In the Columbia River and Snake River basins, steelhead kelt and repeat spawners are primarily tracked using information collected at hydrosystem facilities. Typically, researchers identify kelt and repeat spawners with radio telemetry studies [@wertheimerDownstreamPassageSteelhead2005], biological samples (e.g., scales, genetics) collected from a portion of fish trapped at Bonneville Dam (BON) or Lower Granite Dam (LGD) facilities [@copelandPatternsIteroparityWild2019; @matalaWhatGoesDoes2016; @lawryWildAdultSteelhead2020; @hessDifferentialAdultMigrationtiming2016], or with passive integrated transponder (PIT) tag detections as fish pass the hydrosystems [@copelandPatternsIteroparityWild2019; @keeferIteroparityColumbiaRiver2008]. Using these tools, researchers are able to track migration routes, timing, survival, and estimate the abundance of kelt and repeat spawners within the total steelhead return. @wertheimerDownstreamPassageSteelhead2005 used radio-tags to find kelt survival from Lower Granite Dam (LGD) to below Bonneville Dam (BON) was only 4.1% in 2001 and 15.6% in 2002. And @matalaWhatGoesDoes2016 used mixed stock analysis to proportion kelt and repeat spawners captured at LGD into genetic stock groups, finding greater than 80% of kelt assigned to A-run type genetic stocks as compared to 70% of the returning repeat spawners, while the remainder of the captured steelhead kelt and repeat spawners assigned to B-run stocks. More recently, @copelandPatternsIteroparityWild2019 used a combination of genetic analysis and detections of passive integrated transponder (PIT) tags at LGD and BON to determine survival of kelt emigrating downstream and repeat spawners returning upstream. @copelandPatternsIteroparityWild2019 determined between 2010 and 2015 kelt survival from initial spawning to BON ranged from 10%-44%, 2%-14% for repeat spawners returning from the ocean to BON, and then found a fairly high conversion rate (>65%) of repeat spawners moving from BON to LGD.   

Although most critical information regarding steelhead kelt and repeat spawner survival and abundance is largely known as adults emigrate past LGD towards the ocean, understanding the proportion of fish attempting to kelt, their post-spawning survival or their limiting factors is more elusive. The estimation of kelt metrics upstream of LGD requires the observation of fish immediately after spawning, and prior to any potential downstream migration mortality. Until recently, observations of kelt were limited to only those surviving to reach mainstem observation points (e.g., Lower Granite Dam). However, in the last 10-years in-stream PIT-tag detection systems (IPTDS) have become a wide-spread tool to conduct salmon and steelhead research in the Snake River Basin [@kinzerSnakeRiverBasin2020; @dobosUnderstandingLifeHistory2020; @briana.knothIDAHOADULTSTEELHEAD2018].

Beginning with spawn year 2010, fish managers have relied on the network of IPTDS across the Snake River Basin to gain abundance estimates of steelhead reaching tributary spawning locations [@seePITTagBased2016; @kinzerREPORTNOAAFISHERIES2020]. The method begins by estimating the total number of unique adult steelhead passing LGD as they migrate toward spawning areas [@seeStateSpaceModelEstimate2021], and a systematic sample of PIT-tagged fish passing LGD. The total number of fish passing LGD is then partitioned into spawning areas using a branch-occupancy model described by @seePITTagBased2016 and @waterhouseBayesianNestedPatch2020, and the PIT-tag interrogation data collected at IPTDS. Using the same systematic sample of PIT-tagged fish, and estimated spawner abundances, we hypothesize that downstream emigrating kelt survival and abundance can be estimated at the spawning location. Thus, expanding our knowledge of steelhead kelt distribution, abundance, and survival using existing infrastructure, available data, and building from the previous work of @seePITTagBased2016 and @seeStateSpaceModelEstimate2021. Our work fills an information gap regarding this potentially critical and previously unknown adult steelhead life-history stage (i.e., spawning grounds to LGD), and combined with the findings of @copelandPatternsIteroparityWild2019 can be used to better manage and recover steelhead populations. 

Generally, we seek to better understand the complex kelting life-history of anadromous Snake River steelhead. Our main objective is to provide guidance to fish managers as they review steelhead limiting factors, consider recovery actions, and prioritize life-history stages or populations needing the most assistance. Specifically, we aim to answer three kelt related research questions: (1) what proportion of adult steelhead escaping and spawning in Snake River Basin populations attempt the kelt life-history (i.e., emigrate from spawning area), (2) determine if correlations between kelting rates and demographic characteristics (i.e., age, sex, stock, etc.) exist, and if the rates differ across populations, and (3) what is the survival of kelt from the spawning grounds to LGD and BON? The methods and results presented here provide an analytical framework intended to answer the above stated research questions. The methods section first describes PIT-tag interrogation data as a potential data source, and discusses how interrogation data is processed to classify different adult steelhead life-history stages and summarize PIT-tag observations. Then, a statistical model is described which is capable of expanding PIT-tag observations by detection probabilities to estimate population specific kelting rates and downstream migration survival for spawning populations. Finally, spawn year 2021 data summaries are reported along with tentative model results. Together, the methods and results provide a proof of concept, share currently available information, and begin to illustrate patterns that may emerge after additional modelling using multiple years of data.

# Methods

## Data Source

To begin answering our three research questions we evaluated PIT-tag observations from a random sample of natural-origin adult steelhead captured at Lower Granite Dam during spawn year 2021. We generated PIT-tag observations by first developing a list of natural-origin fish with *valid* PIT-tag codes collected at the Lower Granite Dam adult trap beginning July 1st and ending June 30th of the spawn year [@need_citation]. Fish origin was determined by the presence of an adipose fin and the failure to genetically assign the fish to a hatchery stock using parentage based tagging [@IDFGcitation; @steeleValidationParentagebasedTagging2013]. PIT-tag codes were then deemed valid if a natural-origin fish was trapped while ascending the LGD fish ladder during a systematic sub-sampling period. Once a valid tag list was developed, all PIT-tag interrogations for each tag code was obtained using the complete tag history query from the [PTAGIS](https://www.ptagis.org) website and processed using computer algorithms.

The full dataset was initially processed with the `PITcleanr::compression()` function [@R-PITcleanr] developed for the R statistical language software [@R-base]. The `PITcleanr::compression()` function and the supplied configuration file collapsed multiple rows of PIT-tag interrogations at the same location and during a similar time-period, into a single row of data. The resulting data contained the PIT-tag code, observation location (i.e., node), and the minimum and maximum date/time of observations. Thus, removing any unnecessary and redundant information from the full dataset. The supplied configuration file was constructed using `PITcleanr::buildConfig()` which was then altered to group detection nodes (i.e., a group of PIT-tag antennas or sites) into Lower Columbia, Mid-Columbia, Upper Columbia, and Lower Snake River categories. All detection nodes within the Snake River steelhead distinct population segment (DPS) remained unique, to facilitate the assignment of detections to distinct spawning locations, or populations. We then truncated the compressed observations to include only observations occurring after an upstream migrating steelhead was initially detected at the LGD trap (i.e., we removed all juvenile and adult observations prior to reaching LGD as a returning adult). 

Next, we used the `PITcleanr::addDirection()` function with a supplied parent-child table of nodes to assign detection pathways to each PIT-tag observation, and to define movements as either forward or backward. The parent-child table was pre-constructed and informed the function of each detection pathway (i.e., all possible detection nodes), in the upstream direction, that a fish would pass to reach the actual node of observation. Once the order of detection nodes was known, the `PITcleanr::addDirection()` function labeled observations as either a forward (i.e., upstream) or backward (i.e., downstream) movement.

Then, using the travel pathways and directional movements, each PIT-tag code, or fish, was assigned to one of three LGD migration patterns: typical, fallback, or reascension; and if the fish was observed as a kelt. The migration patterns at LGD described how an upstream migrating steelhead navigated the dam while traveling to the spawning grounds, and enable us to compare the kelting rates and survival of each group. A typical LGD migration pattern was assigned to PIT-tags observed at the LGD trap and ladder once; thus, assuming the fish ascended the ladder and moved directly towards the spawning grounds. The fallback migration pattern was assumed if a single LGD trap or ladder detection was observed, and then was immediately followed by a PIT-tag detection at GRS, GRJ, or any PIT-tag observation site downstream of LGD (e.g., Bonneville Dam corner collector, Preist Rapids ladder, Tucannon River). A reascension fish was assumed to have multiple LGD ladder ascension, and were identified by either PIT-tag interrogations in the ladder or upstream of LGD following a detection GRS, GRJ or another downstream location. We assumed a fish was a kelt on the spawning grounds if there was a backward moving interrogation at an IPTDS at least **X** days after the latest forward movement within the same detection pathway. Kelt observations at LGD was determined if a PIT-tag observation occurred at GRS, GRJ during the months of April, May and June, and the observation was at least 5 days after the last upstream detection on the spawning grounds (**maybe this should be changed to X number of days after the last GRA detection to distinguish from fallback, b/c some kelt can travel from spawning grounds to GRA in less time than 5 days**). We determined a kelt observation at BON if an interrogation at BON existed at any date later then the initial detection of upstream migrating fish at LGD.  

Finally, we processed the dataset with `PITcleanr::filterDetections` which iteratively cycled through each PIT-tag code and observations to determine the final spawn location and valid upstream moving detections. This step was necessary for future modeling with the branch occupancy model [@seePITTagBased2016], and helped ensure that PIT-tagged fish were placed into the correct spawning area, when interrogations and detection pathways indicated a fish was observed in multiple areas. The function first identified if more than one detection pathway existed within the series of observations. If more than one pathway existed, the series of PIT-tag interrogations were flagged for a biologist to determine the correct spawning location based on known spawn timing and behavior for each population. If only one pathway was detected in the complete series of observations, the spawning location or population was assigned based on the furthest upstream detection node. 

### Data Processing Steps

  1. Prepare parent-child table starting with Bonneville Dam as the root observation site, with all other sites upstream.
  1. Build configuration file which maps PTAGIS sites-antennas to detection nodes.
  1. Compress PTAGIS files and add travel direction to each observation using PITcleanR and custom parent-child table, then add steelhead life-stage (i.e., spawner, kelt, repeat spawner) to each observation.
  1. Process spawner observations only using PITcleanR's `filterDetections` to eliminate observations in multiple pathways. Kelt and repeat spawner observations are often in different pathways, so these need to be removed before running the function, and then later called a valid observation.

## Analytical Model
To model the kelting rate and survival rate between observation points we summarized the observation dataset into a more simple capture-history matrix and modeled survival using a Cormack-Jolly Seber model [@lebretonModelingSurvivalTesting1992]. The capture-history matrix included a row for each valid PIT-tag and four columns containing a 1, indicating a PIT-tag observation, and a 0 for a non-observation. The four columns pertained to: (1) PIT-tag codes observed moving upstream at the spawning location, (2) kelt observed moving downstream at the spawning location, (3) kelt observed at LGD, and (4) kelt observed at BON. Each PIT-tag code within the matrix also included group and individual covariate information to allow for differing survival and PIT-tag detection rates. Covariates may include spawning population, genetic stock, kelt migration timing (**not sure this can be done**), sex, age, size, or other metrics that can be assigned to each fish. 

We constructed a state-space Cormack-Jolly-Seber model [@royleHierarchicalModelingInference2008] model to estimate population specific ($p$) survival rates and account for unobserved PIT-tags due to varying detection efficiencies. Using this approach, we estimate survival from the true unknown state ($z_{i,t}$) of individual fish $i$ passing a location at time $t$ with the following process model:

$$
z_{i,p,t+1}|z_{i,p,t} \sim Bernoulii(z_{i,p,t} \phi_{p,t}).
$$
In this formulation, $\phi_{p,t}$ represents the population survival probability for all fish from time $t - 1$ to time $t$. The probability of survival for an individual fish is then the product of the state variable $z_{i,p,t}$ and survival, where $z_{i,p,t}=1$ if a fish is alive at time $t$, and $z_{i,p,t}=0$ if the fish is dead. In absence of a 100% detection rates of downstream moving kelt, we estimated the state process using the imperfect observation data ($y_{i,p,t}$) in the capture history matrix. Given an individual is truely alive at time $t$, we can estimate the probability of detection with the observation model:

$$
y_{i,p,t}|z_{i,p,t} \sim Bernoulii(z_{i,p,t} \rho_{p,t}).
$$
Within the observation model, the detection probability of a fish within population $p$ given they are alive at time $t$ is represented by $\rho_{p,t}$.

*Specific modelling details need included; such as, how population differences are modeled (i.e., fixed vs. random effects), and how individual covariate effects are included.*




# Results

## TODO
+ need to test if kelt rates and survival is equal across all populations....Chi squared test for expected/observed counts
+  need summary of downstream detection locations and timeframe to solidify our kelt calls, for instance, show not many tags observed in upper-c or mid-c during plausible spawning times, and that most detections are during kelt/repeat spawning times
+  need amount of time from spawning obs. to kelt obs in pop, and then at hydro-system
+  run-timing of migrant spawners at LGR and pop.
+  estimate proportion of spawners surviving to LWG from each population, by pooling all detections.

## Data Summary

### How many LGD tags were observed on spawning grounds?
In spawn year 2021, the Lower Granite adult trap released 4,033 valid tags for later detection at IPTDS, hatcheries and other downstream hydrosystem facilities. Of the valid tags released from LGD, approximately 57% (n = 2,315) were determined to spawn upstream of LGD, 3% (n = 113) were presumed to spawn downstream of LGD, and 40% (1,605) had an unknown spawn location (Table \@ref(tab:sum-kelt-loc)). The majority of the fish released from LGD assigned to the Grande Ronde (GRROND) genetic stocks group (Figure \@ref(fig:sum-gsi). The Upper Salmon (UPSALM), Lower Snake (LSNAKE), and Upper Clearwater (UPCLWR) GSI groups were the next numerous for fish released and within the valid list. PIT-tag observation locations suggested spawning occurred in most of the Snake River steelhead populations (Table \@ref(tab:sum-kelt-pop)). Most tags detected on the spawning grounds were observed within the South Fork Clearwater River population (n = 511). The second highest number of tags (n = 246) were seen in the Salmon River upper mainstem population (includes detections from USI and USE PIT-tag arrays). The fewest PIT-tag detections were seen within the Secesh River population (n = 6). Of the PIT-tagged fish detected within population spawning areas, many of them were assigned to non-concordant genetic stocks (Figure \@ref(fig:sum-gsi-pop)). Suggesting spawning fish are straying between populations to a high degree, and/or genetic assignment is not reflective of actual spawner abundance in a population area. Thus, making previous conclusions regarding population life-history or kelting/survival rate differences hard to interpret and generalize to actual spawning populations if methods were based primarily on genetic stock assignments.

### What proportion of tags observed on the spawning grounds were later detected as kelt at Lower Granite Dam or downstream? 
At this time, we are still unable to answer how many kelt are observed leaving the spawning grounds. Methods are currently being developed to more efficiently identify these downstream migrating kelt.

The number of PIT-tags observed on the spawning grounds and later detected as steelhead kelt was 410 unique tags (Table \@ref(tab:sum-kelt-loc)). Of these observed kelt tags, 306 tags were observed at LGD and 155 were observed at BON.  


A minimum rate of kelting plus survival to LGD, for known upstream spawners, was approximately 18%. Of the 1,605 tags that were never observed on the spawning grounds after passing LGD, 23% were later seen heading downstream as kelt. We observed the highest minimum kelting plus survival rate for fish spawning in the Secesh River population (n = 6; 83.3%) and the lowest rate for fish spawning in the South Fork Clearwater River population (n = 511; 4.9%). After reaching LGD, the minimum survival of kelt to Bonneville Dam ranged from 4% for the South Fork Clearwater River spawners, to 66.7% for the Clearwater River lower mainstem and Big, Camas, and Loon Creek populations.

Detection rates of tags on the spawning grounds is different, but they should be similar for all groups at LGD and BON, therefor; survival to BON should be relative to one another.

```{r map, fig.cap = 'Snake River steelhead PIT-tag detection sites located throughout the major population groups upstream of Lower Granite Dam (GRA). Detections of tagged steelhead at each site were used to estimate kelting and survial rates of post-spawn individuals.'}
include_graphics('../../SnakeBasinFishStatus/Figures/site_map.png')
```


```{r node-network, fig.cap = 'Snake River steelhead PIT-tag detection netwwork beginning at Bonneville Dam (BON) and moving upstream into the Snake River and above Lower Granite Dam (GRA). Colored filled detection nodes show the major population groups upstream of Lower Granite Dam used in the study to estimate population specific kelting and survival rates.'}
include_graphics('../../SnakeBasinFishStatus/Figures/node_network_BON.png')
```


```{r ch-obs}
# summarise spawner/kelt/repeat spawner observations for fish spawning upstream of LWG
# other is observation 
tag_summary %>%
  #filter(spawner_above == 1) %>%
  #filter(!(POP_NAME %in% c('GRA'))) %>% #maybe exclude DFNH
  rowwise() %>%
  #mutate(kelt = max(c_across(contains('kelt')))) %>%
  mutate(rs = max(c_across(contains('rs')), na.rm = TRUE)) %>%
  group_by(spawn_year) %>%
  summarise(across(.cols = c(release_LWG, spawner_above, kelt_above, kelt_LWG, kelt_BON, rs), sum, na.rm = TRUE)) %>%
  flextable() %>%
  align(align = 'center', part = 'all') %>%
  set_header_labels(spawn_year = 'Spawn Year', release_LWG = 'Released', spawner_above = 'Spawner',
                    kelt_above = 'Population Kelt', kelt_LWG = 'Lower Granite Kelt', kelt_BON = 'Bonneville Kelt', rs = 'Repeat Spawner') %>%
  #colformat_num(j = 3, digits = 2) %>%
  fit_to_width(max_width = 8) %>%
  #autofit() %>%
  fontsize(size = 8, part = 'all') %>%
  set_caption(caption = 'PIT-tagged natural-origin steelhead released from Lower Granite Dam and later observed in population spawning areas above Lower Granite Dam, as kelt emigrating past population spawning areas, Lower Granite Dam and Bonneville Dam detection points, or as repeat spawners anywhere throughout the Columbia Basin. Observed steelhead were captured and released from the Lower Granite Dam adult trap with PIT-tags during spawn years 2010-2020 and observed from 2010-2021.')
```


```{r sum-gsi, fig.cap = 'Genetic stock of PIT-tagged natural-origin steelhead released at Lower Granite Dam during spawn years 2010-2020 and their final spawn location (y-axis) grouped by major population group and population.', fig.width=6.5, fig.height=7}
# get GSI at LWG, and GSI/PIT spawners and kelt by GSI stock and then by POP
tag_summary %>%
  filter(GenStock != 'NG') %>%
  filter(!is.na(MPG)) %>%
  filter(spawner_above == 1) %>%
  group_by(MPG, TRT_POPID, GenStock) %>%
  summarise(n = n()) %>%
  mutate(p = n/sum(n)) %>%
  ggplot(aes(x = TRT_POPID, y = n)) +
  geom_bar(aes(fill = fct_rev(GenStock)), stat = 'identity', position = 'fill') +
  #geom_text(aes(y = p, label = n), size = 2, position = 'stack', hjust = 1) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_viridis_d(option = 'B', direction = -1, begin = .2) + #, begin = .25, end = .75
  facet_wrap(~MPG, scales = 'free_y', ncol = 2) +
  guides(fill = guide_legend(nrow = 3)) +
  coord_flip() +
  labs(x = '',
      y = 'Percent',
      fill = 'Genetic Stock') +
  theme_rk()
```

```{r sum-gsi-sy20, fig.cap = 'Genetic stock of PIT-tagged natural-origin steelhead released at Lower Granite Dam during spawn year 2020 and their final spawn location (y-axis) grouped by major population group and population.', fig.width=6.5, fig.height=7}
# get GSI at LWG, and GSI/PIT spawners and kelt by GSI stock and then by POP
tag_summary %>%
  filter(spawn_year == 2020) %>%
  filter(GenStock != 'NG') %>%
  filter(!is.na(MPG)) %>%
  filter(spawner_above == 1) %>%
  group_by(MPG, TRT_POPID, GenStock) %>%
  summarise(n = n()) %>%
  mutate(p = n/sum(n)) %>%
  ggplot(aes(x = TRT_POPID, y = n)) +
  geom_bar(aes(fill = fct_rev(GenStock)), stat = 'identity', position = 'fill') +
  #geom_text(aes(y = p, label = n), size = 2, position = 'stack', hjust = 1) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_viridis_d(option = 'B', direction = -1, begin = .2) + #, begin = .25, end = .75
  facet_wrap(~MPG, scales = 'free_y', ncol = 2) +
  guides(fill = guide_legend(nrow = 3)) +
  coord_flip() +
  labs(x = '',
      y = 'Percent',
      fill = 'Genetic Stock') +
  theme_rk()
```


```{r sum-gsi-mpg, fig.cap = 'Genetic stock of PIT-tagged natural-origin steelhead released at Lower Granite Dam during spawn year 2020 and their final spawn location organized by major population group and shown by color.', fig.width=6.5, fig.height=7}
# get GSI at LWG, and GSI/PIT spawners and kelt by GSI stock and then by POP
tag_summary %>%
  filter(spawn_year == 2020) %>%
  filter(GenStock != 'NG') %>%
  filter(!is.na(MPG)) %>%
  filter(spawner_above == 1) %>%
  group_by(MPG, TRT_POPID, GenStock) %>%
  summarise(n = n()) %>%
  mutate(p = n/sum(n)) %>%
  ggplot(aes(x = GenStock, y = n)) +
  geom_bar(aes(fill = fct_rev(MPG)), stat = 'identity', position = 'fill') +
  #geom_text(aes(y = p, label = n), size = 2, position = 'stack', hjust = 1) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_viridis_d(option = 'B', direction = -1, begin = .2) + #, begin = .25, end = .75
  #facet_wrap(~MPG, scales = 'free_y', ncol = 2) +
  guides(fill = guide_legend(nrow = 3)) +
  coord_flip() +
  labs(x = 'GSI Group',
      y = 'Percent',
      fill = 'MPG') +
  theme_rk()
```


```{r sum-gsi-pop-percent, fig.cap = 'Genetic stock of PIT-tagged natural-origin steelhead released at Lower Granite Dam during spawn year 2020 and their final spawn location organized by population and shown by color.', fig.width=6.5, fig.height=7}
# get GSI at LWG, and GSI/PIT spawners and kelt by GSI stock and then by POP
tag_summary %>%
  filter(spawn_year == 2020) %>%
  filter(GenStock != 'NG') %>%
  filter(!is.na(MPG)) %>%
  filter(spawner_above == 1) %>%
  group_by(MPG, TRT_POPID, GenStock) %>%
  summarise(n = n()) %>%
  mutate(p = n/sum(n)) %>%
  ggplot(aes(x = GenStock, y = n)) +
  geom_bar(aes(fill = fct_rev(TRT_POPID)), stat = 'identity', position = 'fill') +
  #geom_text(aes(y = p, label = n), size = 2, position = 'stack', hjust = 1) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_viridis_d(option = 'B', direction = -1, begin = .2) + #, begin = .25, end = .75
  #facet_wrap(~MPG, scales = 'free_y', ncol = 2) +
  guides(fill = guide_legend(nrow = 5, ncol = 5)) +
  coord_flip() +
  labs(x = 'GSI Group',
      y = 'Percent',
      fill = 'POP') +
  theme_rk()
```



```{r sum-gsi-pop-count, fig.cap = 'Genetic stock of PIT-tagged natural-origin steelhead released at Lower Granite Dam during spawn year 2020 and their final spawn location organized by population and shown by color.', fig.width=6.5, fig.height=7}
# get GSI at LWG, and GSI/PIT spawners and kelt by GSI stock and then by POP
tag_summary %>%
  filter(spawn_year == 2020) %>%
  filter(GenStock != 'NG') %>%
  filter(!is.na(MPG)) %>%
  filter(spawner_above == 1) %>%
  group_by(MPG, TRT_POPID, GenStock) %>%
  summarise(n = n()) %>%
  mutate(p = n/sum(n)) %>%
  ggplot(aes(x = GenStock, y = n)) +
  geom_bar(aes(fill = fct_rev(TRT_POPID)), stat = 'identity') +
  #geom_text(aes(y = p, label = n), size = 2, position = 'stack', hjust = 1) +
  #scale_y_continuous(labels = scales::percent) +
  scale_fill_viridis_d(option = 'B', direction = -1, begin = .2) + #, begin = .25, end = .75
  #facet_wrap(~MPG, scales = 'free_y', ncol = 2) +
  guides(fill = guide_legend(nrow = 5, ncol = 5)) +
  coord_flip() +
  labs(x = 'GSI Group',
      y = 'Percent',
      fill = 'POP') +
  theme_rk()
```


```{r sum-gsi-count-matrix}
tag_summary %>%
  filter(spawn_year == 2020) %>%
  filter(GenStock != 'NG') %>%
  filter(!is.na(MPG)) %>%
  filter(spawner_above == 1) %>%
  group_by(GSI_spawn, GenStock) %>%
  summarise(n = n()) %>%
  #mutate(p = n/sum(n)) %>%
  pivot_wider(names_from = 'GenStock', values_from = 'n') %>%
  flextable() %>%
  align(align = 'center', part = 'all') %>%
  # set_header_labels(spawn_year = 'Spawn Year', release_LWG = 'Released', spawner_above = 'Spawner',
  #                   kelt_above = 'Population Kelt', kelt_LWG = 'Lower Granite Kelt', kelt_BON = 'Bonneville Kelt', rs = 'Repeat Spawner') %>%
  #colformat_num(j = 3, digits = 2) %>%
  fit_to_width(max_width = 8) %>%
  #autofit() %>%
  fontsize(size = 8, part = 'all') %>%
  set_caption(caption = 'PIT-tag observed spawn location by GSI grouping (rows) and the GSI assignment location (columns) for fish sampled during spawn year 2020.')
```


```{r sum-gsi-count-plot, fig.cap = 'Proportion of PIT-tagged fish assigned to each stock location based on genetic assignment and observed tag detection.', fig.width=6.5, fig.height=7}
tag_summary %>%
  filter(spawn_year == 2020) %>%
  filter(GenStock != 'NG') %>%
  filter(!is.na(MPG)) %>%
  filter(spawner_above == 1) %>%
  cuyem::est_group_p(GSI_spawn) %>%
  mutate(method = 'PIT') %>%
  rename(group = GSI_spawn) %>%
  bind_rows(
    tag_summary %>%
    filter(spawn_year == 2020) %>%
    filter(GenStock != 'NG') %>%
    filter(!is.na(MPG)) %>%
    filter(spawner_above == 1) %>%
    cuyem::est_group_p(GenStock) %>%
    mutate(method = 'GSI') %>%
    rename(group = GenStock)
  ) %>%
  ggplot(aes(x = group, y = p, colour = method)) +
  geom_errorbar(aes(ymin = lwr, ymax = upr), position = position_dodge(width = .5)) +
  geom_point(position = position_dodge(width = .5)) +
  scale_colour_viridis_d(option = 'B', direction = -1, begin = .2, end = .5) +
  labs(x = 'Group',
      y = 'Percent',
      colour = 'Determiniation Method') +
  theme_rk()
```


```{r sum-pop-counts}
# summarise final spawning population location
pop_cnts <- tag_summary %>%
  filter(spawner_above == 1) %>%
  rowwise() %>%
  mutate(kelt = max(c_across(contains('kelt')), na.rm = TRUE)) %>%
  mutate(rs = max(c_across(contains('rs')), na.rm = TRUE)) %>%
  group_by(spawn_year, MPG, POP_NAME, TRT_POPID) %>%
  summarise(across(.cols = c(spawner_above, kelt_above, kelt_LWG, kelt_BON, kelt, rs), sum, na.rm = TRUE))
```


```{r plot-pop-spawners, fig.cap = 'Total PIT-tag detections of natural-origin steelhead spawning in Snake River populations upstream of Lower Granite Dam during spawn years 2010-2020.', fig.width = 6.5, fig.height = 5}
pop_cnts %>%
  filter(!is.na(MPG)) %>%
  filter(spawner_above != 0) %>%
  ggplot(aes(x = fct_rev(TRT_POPID), y = spawn_year, fill = spawner_above)) +
  geom_tile() +
  geom_text(aes(label = spawner_above), size = 2) +
  scale_fill_viridis_c(option = 'E', begin = .2) +
  coord_flip() +
  labs(x = '',
       y = 'Spawn Year',
       fill = 'Spawners') +
  theme_rk() +
  theme(legend.key.width = unit(1, 'cm'),
        legend.key.height = unit(.25, 'cm'),
        plot.title.position = 'plot')
```



```{r plot-kelt-pop}
a <- pop_cnts %>%
  filter(!is.na(MPG)) %>%
  filter(kelt != 0) %>%
  ggplot(aes(x = fct_rev(TRT_POPID), y = spawn_year, fill = kelt_above)) +
  geom_tile() +
  geom_text(aes(label = kelt_above), size = 2) +
  scale_fill_viridis_c(option = 'E', begin = .2) +
  coord_flip() +
  labs(title = '(A)',
       x = '',
       y = 'Spawn Year',
       fill = 'Population') +
  theme_rk() +
  theme(legend.key.width = unit(1, 'cm'),
        legend.key.height = unit(.25, 'cm'),
        plot.title.position = 'plot')
```


```{r plot-kelt-lgd}
b <- pop_cnts %>%
  filter(!is.na(MPG)) %>%
  filter(kelt != 0) %>%
  ggplot(aes(x = fct_rev(TRT_POPID), y = spawn_year, fill = kelt_LWG)) +
  geom_tile() +
  geom_text(aes(label = kelt_LWG), size = 2) +
  scale_fill_viridis_c(option = 'E', begin = .2) +
  coord_flip() +
  labs(title = '(B)',
       x = '',
       y = 'Spawn Year',
       fill = 'Lower Granite Dam') +
  theme_rk() +
  theme(legend.key.width = unit(1, 'cm'),
        legend.key.height = unit(.25, 'cm'),
        plot.title.position = 'plot')
```


```{r plot-kelt-bon}
c <- pop_cnts %>%
  filter(!is.na(MPG)) %>%
  filter(kelt != 0) %>%
  ggplot(aes(x = fct_rev(TRT_POPID), y = spawn_year, fill = kelt_BON)) +
  geom_tile() +
  geom_text(aes(label = kelt_BON), size = 2) +
  scale_fill_viridis_c(option = 'E', begin = .2) +
  coord_flip() +
  labs(title = '(C)',
       x = '',
       y = 'Spawn Year',
       fill = 'Bonneville Dam') +
  theme_rk() +
  theme(legend.key.width = unit(1, 'cm'),
        legend.key.height = unit(.25, 'cm'),
        plot.title.position = 'plot')
```


```{r plot-observed, fig.cap = 'Total PIT-tag detections of post-spawned natural-origin steelhead kelt emigrating from Sanke River populations upstream of Lower Granite Dam from spawn years 2010-2020. Panel A shows the number of kelt detected leaving population spawning areas, panel B shows the number of kelt detected at Lower Granite Dam, and panel C shows detections at Bonneville Dam.', fig.height = 10, fig.width=6.5}
library(patchwork)
a / b / c
```


```{r plot-pop-rs, fig.cap = 'Total detections of natural-origin steelhead repeat spawners originating from PIT-tagged fish released from Lower Granite Dam which spawned upstream of the dam during spawn years 2010-2020. The detection counts are grouped by population spawning area assigned during the first spawning event.', fig.width = 6.5, fig.height = 5}
pop_cnts %>%
  filter(!is.na(MPG)) %>%
  filter(rs != 0) %>%
  ggplot(aes(x = fct_rev(TRT_POPID), y = spawn_year, fill = rs)) +
  geom_tile() +
  geom_text(aes(label = rs), size = 2) +
  scale_fill_viridis_c(option = 'E', direction = 1, begin = .2) +
  coord_flip() +
  labs(x = '',
       y = 'Spawn Year',
       fill = 'Repeat Spawners') +
  theme_rk() +
  theme(legend.key.width = unit(1, 'cm'),
        legend.key.height = unit(.25, 'cm'),
        plot.title.position = 'plot')
```

```{r gsi-kelt, eval = FALSE}
tag_summary %>%
  filter(GenStock != 'NG') %>%
  filter(!is.na(MPG)) %>%
  filter(spawner_above == 1) %>%
  group_by(MPG, TRT_POPID, GenStock) %>%
  summarise(n = sum(kelt_LWG)) %>%
  mutate(p = n/sum(n)) %>%
  ggplot(aes(x = TRT_POPID, y = n)) +
  geom_bar(aes(fill = fct_rev(GenStock)), stat = 'identity', position = 'fill') +
  #geom_text(aes(y = p, label = n), size = 2, position = 'stack', hjust = 1) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_viridis_d(option = 'B', direction = -1, begin = .2) + #, begin = .25, end = .75
  facet_wrap(~MPG, scales = 'free_y', ncol = 2) +
  guides(fill = guide_legend(nrow = 2)) +
  coord_flip() +
  labs(x = '',
      y = 'Percent',
      fill = 'Genetic Stock') +
  theme_rk()
```


```{r kelt-arrival-pop, fig.cap = 'Arrival distribution of PIT-tagged natural-origin steelhead to spawning locations for the three adult life-stages; spawner, post-spawned kelt, and repeat spawner. Tagged steelhead were released from the Lower Granite Dam adult trap during spawn years 2010-2020.', fig.height = 6, fig.width=6.5}
# indicates most kelt obs at GRS begin in March
viridis_pal <- viridis::plasma(n = 3, begin = .2, end = .8, direction = -1)

lifestage_obs %>%
  mutate(life_stage = factor(life_stage, levels = c('spawner', 'kelt', 'repeat spawner'))) %>%
  ungroup() %>%
  mutate(m = str_pad(month(min_det), width = 2, pad = 0),
         d = str_pad(day(min_det),width = 2, pad = 0),
         y = if_else(month(min_det) < 7, 2020,2019),
         y = if_else(life_stage == 'repeat spawner', 2020, y),
         tmp_date = ymd(as.character(paste0(y,m,d)))) %>%
  filter(!is.na(MPG)) %>%
  #filter(life_stage == 'kelt') %>%
  filter(node_order > 9) %>%
  group_by(tag_code, life_stage) %>%
  slice(which.min(min_det)) %>%
  ggplot(aes(x =tmp_date)) +
  geom_bar(aes(fill = life_stage), position = 'identity', alpha = .5, binwidth = 1) +
  scale_fill_manual(values = viridis_pal, breaks = c('spawner', 'kelt', 'repeat spawner')) +
  scale_x_date(date_breaks = '1 month', date_labels = format('%m-%d')) +
  labs(x = 'Date',
       y = 'Observed',
       fill = 'Life Stage') +
  #facet_wrap(~spawn_year, scales = 'free') +
  theme_rk()
```


```{r kelt-arrival-grs, fig.cap = 'Arrival distribution of PIT-tagged natural-origin steelhead to Lower Granite Dam for the three adult life-stages; spawner, post-spawned kelt, and repeat spawner. Tagged steelhead were released from the Lower Granite Dam adult trap during spawn years 2010-2020.', fig.height = 6, fig.width=6.5}
# indicates most kelt obs at GRS begin in March
lifestage_obs %>%
  mutate(life_stage = factor(life_stage, levels = c('spawner', 'kelt', 'repeat spawner'))) %>%
  ungroup() %>%
  mutate(m = str_pad(month(min_det), width = 2, pad = 0),
         d = str_pad(day(min_det),width = 2, pad = 0),
         y = if_else(month(min_det) < 7, 2020,2019),
         y = if_else(life_stage == 'repeat spawner', 2020, y),
         tmp_date = ymd(as.character(paste0(y,m,d)))) %>%
  #filter(spawn_year == 2010) %>%
  filter(node %in% c('GRS', 'GRA')) %>%
  #filter(life_stage != 'repeat spawner') %>%
  group_by(tag_code, node, life_stage) %>%
  slice(which.min(min_det)) %>%
  ggplot(aes(x = tmp_date)) +
  geom_bar(aes(fill = life_stage), position = 'identity', alpha = .5, binwidth = 1) +
  scale_fill_manual(values = viridis_pal, breaks = c('spawner', 'kelt', 'repeat spawner')) +
  scale_x_date(date_breaks = '1 month', date_labels = format('%b-%d')) +
  labs(x = 'Date',
       y = 'Observed',
       fill = 'Life Stage') +
  #facet_grid(spawn_year ~ ., scales = 'free') +
  theme_rk()
```

```{r kelt-arrival-bon, fig.cap = 'Arrival distribution of PIT-tagged natural-origin steelhead for two adult life stages observed at Bonneville Dam; post-spawned kelt, and repeat spawner. Tagged steelhead were released from the Lower Granite Dam adult trap during spawn years 2010-2020.', fig.height = 6, fig.width=6.5}
# indicates most kelt obs at bon begin in March
lifestage_obs %>%
  mutate(life_stage = factor(life_stage, levels = c('spawner', 'kelt', 'repeat spawner'))) %>%
  ungroup() %>%
  mutate(m = str_pad(month(min_det), width = 2, pad = 0),
         d = str_pad(day(min_det),width = 2, pad = 0),
         y = if_else(month(min_det) <= 7, 2020,2019),
         y = if_else(life_stage == 'repeat spawner', 2020, y),
         tmp_date = ymd(as.character(paste0(y,m,d)))) %>%
  filter(node %in% c('BON')) %>%
  #filter(life_stage != 'repeat spawner') %>%
  group_by(tag_code, life_stage) %>%
  slice(which.min(min_det)) %>%
  ggplot(aes(x = tmp_date)) +
  geom_bar(aes(fill = life_stage), position = 'identity', alpha = .5, binwidth = 1) +
  scale_fill_manual(values = viridis_pal, breaks = c('spawners', 'kelt', 'repeat spawner')) +
  scale_x_date(date_breaks = '1 month', date_labels = format('%b-%d')) +
  #facet_grid(spawn_year ~ ., scales = 'free') +
  labs(x = 'Date',
       y = 'Observed',
       fill = 'Life Stage') +
  theme_rk()
```


## Data Analysis


# Discussion

+ GSI assignment proportions are similar across spawners, kelt (all locations) and repeat spawners
+ Spillway weir in 2020 lead to more kelt detections at Lower Granite
+ Defining kelt or enumerating kelting rates at Lower Granite (i.e., in the hydrosystem) deflates the true number of fish migrating downstream as kelt and attempting to be a repeat spawner.
+ Lolo and SFCLW have similar kelting rates, and spawners in both locations genetically assign to SFCLWR.
+ Older B-run type fish in the Salmon have higher kelting rates than Clearwater B-run.

\newpage
# References